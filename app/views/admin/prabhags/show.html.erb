<div class="w-full">
  <div class="flex justify-between items-center mb-8">
    <h1 class="font-bold text-3xl">Admin: Prabhag <%= @prabhag.number %></h1>
    <%= link_to "← Back to Admin Dashboard", admin_prabhags_path, class: "text-blue-500 hover:text-blue-700" %>
  </div>
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <!-- Prabhag Information -->
    <div class="space-y-6">
      <div class="bg-white border rounded-lg p-6 shadow-sm">
        <h2 class="text-xl font-semibold mb-4">Prabhag Information</h2>
        <dl class="space-y-2">
          <div class="flex justify-between">
            <dt class="font-medium text-gray-600">Number:</dt>
            <dd class="text-gray-900"><%= @prabhag.number %></dd>
          </div>
          <div class="flex justify-between">
            <dt class="font-medium text-gray-600">Ward:</dt>
            <dd class="text-gray-900"><%= @prabhag.ward_code %></dd>
          </div>
          <div class="flex justify-between">
            <dt class="font-medium text-gray-600">Status:</dt>
            <dd>
              <% case @prabhag.status %>
              <% when 'available' %>
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">Available</span>
              <% when 'assigned' %>
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">In Progress</span>
              <% when 'submitted' %>
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">Under Review</span>
              <% when 'approved' %>
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Completed</span>
              <% when 'rejected' %>
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">Rejected</span>
            <% end %>
          </dd>
        </div>
        <% if @prabhag.assigned_to %>
          <div class="flex justify-between">
            <dt class="font-medium text-gray-600">Assigned to:</dt>
            <dd class="text-gray-900"><%= @prabhag.assigned_to.name || @prabhag.assigned_to.email %></dd>
          </div>
        <% end %>
        <% if @prabhag.has_boundary? %>
          <div class="flex justify-between">
            <dt class="font-medium text-gray-600">Boundaries:</dt>
            <dd class="text-gray-900"><%= @prabhag.boundaries.count %> submitted</dd>
          </div>
          <% if @geojson_data %>
            <div class="flex justify-between">
              <dt class="font-medium text-gray-600">Boundary Points:</dt>
              <dd class="text-gray-900"><%= @geojson_data.dig("geometry", "coordinates", 0)&.length || 0 %></dd>
            </div>
          <% end %>
        <% end %>
      </dl>
    </div>
    <!-- Admin Actions -->
    <div class="bg-white border rounded-lg p-6 shadow-sm">
      <h2 class="text-xl font-semibold mb-4">Admin Actions</h2>
      <div class="space-y-3">
        <%= link_to "View PDF", @prabhag.pdf_url, target: '_blank',
                      class: "block w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded text-center" %>

        <% pending_boundaries = @prabhag.boundaries.where(status: 'pending') %>
        <% if pending_boundaries.any? %>
          <div class="bg-yellow-100 text-yellow-800 font-bold py-2 px-4 rounded text-center">
            ⏳ <%= pending_boundaries.count %> Pending Review
          </div>
          <%= link_to boundaries_admin_prabhag_path(@prabhag),
                      class: "block w-full bg-orange-500 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded text-center" do %>
            <i class="fas fa-clipboard-check mr-2"></i>
            Review Boundaries
          <% end %>
        <% elsif @prabhag.boundaries.where(status: 'approved').any? %>
          <div class="bg-green-100 text-green-800 font-bold py-2 px-4 rounded text-center">
            ✅ Has Approved Boundary
          </div>
        <% elsif @prabhag.boundaries.where(status: 'rejected').any? && !@prabhag.boundaries.where(status: ['approved', 'canonical']).any? %>
          <div class="bg-red-100 text-red-800 font-bold py-2 px-4 rounded text-center">
            ❌ Previous Submissions Rejected
          </div>
        <% else %>
          <div class="bg-gray-100 text-gray-600 font-bold py-2 px-4 rounded text-center">
            <%= @prabhag.status == 'available' ? 'Available for Assignment' : 'In Progress' %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
  <!-- Boundary History Section -->
  <% if @prabhag.boundaries.any? %>
    <div class="bg-white border rounded-lg p-6 shadow-sm mb-6">
      <h2 class="text-xl font-semibold mb-4">Boundary History</h2>
      <div class="space-y-3">
        <% @prabhag.boundaries.order(:created_at).reverse_each do |boundary| %>
          <div class="border rounded-lg p-3 <%= boundary.status == 'approved' ? 'border-green-200 bg-green-50' : boundary.status == 'rejected' ? 'border-red-200 bg-red-50' : boundary.status == 'canonical' ? 'border-purple-200 bg-purple-50' : 'border-yellow-200 bg-yellow-50' %>">
            <div class="flex justify-between items-center">
              <div>
                <div class="flex items-center space-x-2">
                  <% case boundary.status %>
                  <% when 'approved' %>
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">✅ Approved</span>
                  <% when 'rejected' %>
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">❌ Rejected</span>
                  <% when 'canonical' %>
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-800">⭐ Canonical</span>
                  <% when 'pending' %>
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">⏳ Pending Review</span>
                  <% end %>
                  <span class="text-sm text-gray-600"><%= boundary.source_type.humanize %> • <%= boundary.year %></span>
                </div>
                <div class="text-sm text-gray-600 mt-1">
                  Submitted <%= time_ago_in_words(boundary.created_at) %> ago
                  <% if boundary.submitted_by %>
                    by <%= boundary.submitted_by.name || boundary.submitted_by.email %>
                  <% end %>
                </div>
                <% if boundary.approved_by && boundary.approved_at %>
                  <div class="text-sm text-gray-600">
                    Approved by <%= boundary.approved_by.name || boundary.approved_by.email %>
                    <%= time_ago_in_words(boundary.approved_at) %> ago
                  </div>
                <% end %>
                <% if boundary.rejection_reason.present? %>
                  <div class="text-sm text-red-600 mt-1">
                    <strong>Reason:</strong> <%= boundary.rejection_reason %>
                  </div>
                <% end %>
              </div>

              <div class="flex space-x-2">
                <!-- View boundary details link -->
                <%= link_to "View Details", admin_boundary_path(boundary),
                            class: "bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded text-xs",
                            title: "View boundary details" %>

                <!-- Action buttons for pending boundaries -->
                <% if boundary.status == 'pending' %>
                  <%= button_to "✅", approve_admin_boundary_path(boundary),
                                class: "bg-green-500 hover:bg-green-700 text-white font-bold py-1 px-2 rounded text-xs",
                                title: "Approve this boundary",
                                data: { confirm: "Approve this boundary submission?" } %>
                  <%= button_to "❌", reject_admin_boundary_path(boundary),
                                class: "bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded text-xs",
                                title: "Reject this boundary",
                                data: { confirm: "Reject this boundary submission?" } %>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Map Preview -->
  <div class="bg-white border rounded-lg p-6 shadow-sm">
    <h2 class="text-xl font-semibold mb-4">Boundary Review</h2>
    <% boundary_to_show = @prabhag.boundaries.where(status: 'pending').order(:created_at).last || @prabhag.boundary %>
    <% if boundary_to_show&.geojson.present? %>
      <div class="mb-3 text-sm text-gray-600">
        Showing <%= boundary_to_show.status %> boundary
        (<%= boundary_to_show.source_type.humanize %>, <%= boundary_to_show.year %>)
        <% if boundary_to_show.submitted_by %>
          submitted by <%= boundary_to_show.submitted_by.name || boundary_to_show.submitted_by.email %>
        <% end %>
      </div>
      <div id="map" class="border rounded h-96"></div>
      <script>
        function initMap() {
          const geojson = <%= boundary_to_show.geojson.html_safe %>;
          const coordinates = geojson.geometry.coordinates[0];
          const path = coordinates.map(coord => ({ lat: coord[1], lng: coord[0] }));

          // Calculate center
          const bounds = new google.maps.LatLngBounds();
          path.forEach(point => bounds.extend(point));
          const center = bounds.getCenter();

          const map = new google.maps.Map(document.getElementById('map'), {
            center: center,
            zoom: 15,
            mapTypeId: 'roadmap'
          });

          // Fit bounds to polygon
          map.fitBounds(bounds, 50);

          // Create the polygon
          const polygon = new google.maps.Polygon({
            paths: path,
            strokeColor: '<%= boundary_to_show.status == 'canonical' ? '#8B5CF6' : boundary_to_show.status == 'approved' ? '#10B981' : boundary_to_show.status == 'rejected' ? '#EF4444' : '#F59E0B' %>',
            strokeOpacity: 0.8,
            strokeWeight: 3,
            fillColor: '<%= boundary_to_show.status == 'canonical' ? '#8B5CF6' : boundary_to_show.status == 'approved' ? '#10B981' : boundary_to_show.status == 'rejected' ? '#EF4444' : '#F59E0B' %>',
            fillOpacity: 0.2,
            editable: false,
            clickable: false
          });

          polygon.setMap(map);
        }
      </script>
      <script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_MAPS_API_KEY'] %>&callback=initMap" async defer></script>
      <% if @prabhag.status == 'submitted' %>
        <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded">
          <h3 class="font-semibold text-blue-900 mb-2">Review Instructions</h3>
          <ul class="text-sm text-blue-800 space-y-1">
            <li>• Verify the boundary follows the prabhag lines accurately</li>
            <li>• Check that all boundary points are correctly placed</li>
            <li>• Ensure the polygon is complete and properly closed</li>
            <li>• Compare with the reference PDF if needed</li>
          </ul>
        </div>
      <% end %>
    <% else %>
      <div class="border rounded h-96 bg-gray-50 flex items-center justify-center">
        <div class="text-center text-gray-600">
          <p>No boundary traced yet</p>
          <p class="text-sm">Boundary will appear here once traced</p>
        </div>
      </div>
    <% end %>
  </div>
</div>
</div>
