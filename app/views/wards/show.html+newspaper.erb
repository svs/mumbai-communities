<%
  mapped_count = @prabhags.select { |p| p.boundary_geojson.present? }.count
  unmapped_count = @prabhags.count - mapped_count
%>

<div class="max-w-5xl mx-auto py-8 px-4">

  <!-- Two-column layout: Left (8) = header + tweets, Right (4) = map + prabhags -->
  <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 mb-12">

    <!-- Left column (8/12) -->
    <div class="lg:col-span-8">
      <!-- Masthead -->
      <div class="mb-2">
        <%= link_to "\u2190 All Wards", wards_path, class: "text-sm text-stone-400 hover:text-stone-600 transition-colors" %>
      </div>
      <h1 class="newspaper-masthead text-5xl text-stone-900 mb-2">
        Ward <%= @ward.ward_code %>
      </h1>
      <p class="text-xs uppercase tracking-widest text-stone-400 mb-4">
        Mumbai Municipal Corporation
      </p>
      <div class="newspaper-rule-thick mb-4"></div>
      <p class="text-sm text-stone-500 mb-8">
        <%= @prabhags.count %> Prabhags
        · <%= mapped_count %>/<%= @prabhags.count %> mapped
        <% if @ward.population_estimate.present? %>
          · Pop. <%= number_with_delimiter(@ward.population_estimate) %>
        <% end %>
      </p>

      <!-- Tweets -->
      <% if @tweets.any? %>
        <div data-controller="twitter-embeds">
          <div class="newspaper-section-header">From the Community</div>
          <div class="space-y-4">
            <%= render @tweets %>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Right column (4/12) -->
    <div class="lg:col-span-4">
      <!-- Map -->
      <div class="mb-8"
           data-controller="leaflet-map"
           data-leaflet-map-data-url-value="/wards/<%= @ward.ward_code %>.json"
           data-leaflet-map-show-labels-value="false"
           data-leaflet-map-show-legend-value="false"
           data-leaflet-map-clickable-value="true"
           data-leaflet-map-zoom-value="14"
           data-leaflet-map-static-value="true">
        <div data-leaflet-map-target="container" class="aspect-square w-full desaturated-map rounded-lg"></div>
      </div>

      <!-- Prabhags -->
      <div class="newspaper-section-header">Prabhags</div>
      <div class="space-y-3">
        <% @prabhags.each do |prabhag| %>
          <% boundary = prabhag.approved_boundary %>
          <%
            if boundary
              case boundary.source_type
              when 'official_import'
                border_color = 'border-green-500'
                status_text = boundary.status == 'canonical' ? 'Official' : 'Approved'
                status_class = 'bg-green-50 text-green-700'
              when 'kml_import'
                border_color = 'border-orange-400'
                status_text = 'Legacy'
                status_class = 'bg-orange-50 text-orange-700'
              when 'user_submission'
                border_color = 'border-purple-400'
                status_text = 'Community'
                status_class = 'bg-purple-50 text-purple-700'
              else
                border_color = 'border-stone-300'
                status_text = boundary.source_type.humanize
                status_class = 'bg-stone-50 text-stone-600'
              end
            else
              border_color = 'border-red-400'
              status_text = 'Needs mapping'
              status_class = 'bg-red-50 text-red-700'
            end
          %>
          <%= link_to prabhag_path(prabhag), class: "prabhag-card block border-t-4 #{border_color} bg-white rounded-lg border border-stone-200 p-4 hover:no-underline" do %>
            <div class="text-lg font-semibold text-stone-800 mb-2">
              Prabhag <%= prabhag.number %>
            </div>
            <span class="inline-block text-xs font-medium px-2 py-1 rounded-full <%= status_class %>">
              <%= status_text %>
            </span>
          <% end %>
        <% end %>
      </div>
    </div>

  </div>

  <!-- Two-column: Help + Directory -->
  <%
    has_help_content = unmapped_count > 0 || @open_tickets.any?
    has_directory = @ward.contact_officer_name.present?
  %>
  <% if has_help_content || has_directory %>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-12 mb-12">
      <% if has_help_content %>
        <div>
          <div class="newspaper-section-header">How You Can Help</div>
          <div class="text-stone-600 space-y-3">
            <% if unmapped_count > 0 %>
              <p><%= unmapped_count %> prabhag<%= unmapped_count == 1 ? '' : 's' %> still need<%= unmapped_count == 1 ? 's' : '' %> boundary mapping.</p>
            <% end %>
            <% if @open_tickets.any? %>
              <p><%= @open_tickets.count %> task<%= @open_tickets.count == 1 ? '' : 's' %> need<%= @open_tickets.count == 1 ? 's' : '' %> volunteers.</p>
            <% end %>
            <% unless user_signed_in? %>
              <p class="text-sm">
                <%= link_to "Sign up", new_user_registration_path, class: "text-stone-700 underline hover:text-stone-900" %>
                or
                <%= link_to "sign in", new_user_session_path, class: "text-stone-700 underline hover:text-stone-900" %>
                to contribute.
              </p>
            <% end %>
          </div>
        </div>
      <% end %>

      <% if has_directory %>
        <div>
          <div class="newspaper-section-header">Ward Directory</div>
          <div class="text-sm text-stone-600 space-y-2">
            <div><strong class="text-stone-800">Ward Officer:</strong> <%= @ward.contact_officer_name %></div>
            <% if @ward.contact_officer_email.present? %>
              <div>
                <a href="mailto:<%= @ward.contact_officer_email %>" class="text-stone-700 underline hover:text-stone-900">
                  <%= @ward.contact_officer_email %>
                </a>
              </div>
            <% end %>
            <% if @ward.contact_officer_phone.present? %>
              <div>
                <a href="tel:<%= @ward.contact_officer_phone %>" class="text-stone-700 underline hover:text-stone-900">
                  <%= @ward.contact_officer_phone %>
                </a>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>

  <!-- Recently Completed -->
  <% if @completed_tickets.any? %>
    <div class="mb-12">
      <div class="newspaper-section-header">Recently Completed</div>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <% @completed_tickets.limit(6).each do |ticket| %>
          <div class="border-l-2 border-green-300 pl-4">
            <h3 class="font-medium text-stone-800 mb-1"><%= ticket.title %></h3>
            <div class="text-sm text-stone-500 space-y-1">
              <div>By: <%= ticket.assigned_to&.name || ticket.assigned_to&.email || 'Volunteer' %></div>
              <div><%= time_ago_in_words(ticket.updated_at) %> ago</div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Footer Links -->
  <div class="newspaper-rule mb-6"></div>
  <div class="flex justify-center gap-8 text-sm text-stone-500">
    <%= link_to "Browse all prabhags", ward_prabhags_path(@ward.ward_code),
                class: "hover:text-stone-800 underline" %>
    <a href="https://portal.mcgm.gov.in" target="_blank" class="hover:text-stone-800 underline">
      MCGM Portal
    </a>
  </div>

</div>
