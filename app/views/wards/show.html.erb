<div class="max-w-4xl mx-auto space-y-8">
  <!-- Ward Header -->
  <div class="border-b border-gray-300 pb-6">
    <div class="flex justify-between items-start">
      <div>
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Ward <%= @ward.ward_code %></h1>
        <p class="text-gray-600">Mumbai Municipal Corporation</p>
        <% if @ward.population_estimate.present? %>
          <p class="text-sm text-gray-500 mt-1">Population: <%= number_with_delimiter(@ward.population_estimate) %></p>
        <% end %>
      </div>
      <div class="text-right">
        <%= link_to "← All Wards", wards_path, class: "text-blue-600 hover:underline" %>
        <div class="mt-2 text-sm text-gray-500">
          <span><%= @ward.completion_percentage.to_i %>% mapped</span>
          <% if @ward.is_geocoded %>
            <span class="ml-2">• Geocoded</span>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Stats -->
  <div class="grid grid-cols-4 gap-8 text-center border-b border-gray-200 pb-6">
    <div>
      <div class="text-2xl font-bold text-gray-900"><%= @prabhags.count %></div>
      <div class="text-sm text-gray-600">Prabhags</div>
    </div>
    <div>
      <div class="text-2xl font-bold text-gray-900"><%= @open_tickets.count %></div>
      <div class="text-sm text-gray-600">Active Issues</div>
    </div>
    <div>
      <div class="text-2xl font-bold text-gray-900"><%= @completed_tickets.count %></div>
      <div class="text-sm text-gray-600">Resolved</div>
    </div>
    <div>
      <div class="text-2xl font-bold text-gray-900"><%= @prabhags.select { |p| p.boundary_geojson.present? }.count %></div>
      <div class="text-sm text-gray-600">Mapped</div>
    </div>
  </div>

  <!-- Ward Overview Map -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-8"
       data-controller="leaflet-map"
       data-leaflet-map-data-url-value="/wards/<%= @ward.ward_code %>.json"
       data-leaflet-map-show-labels-value="false"
       data-leaflet-map-show-legend-value="false"
       data-leaflet-map-clickable-value="true"
       data-leaflet-map-zoom-value="14"
       data-leaflet-map-static-value="true">
    <div data-leaflet-map-target="container" class="h-64 w-full desaturated-map">
      <!-- Ward overview map will be loaded here -->
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
    <!-- Main Content -->
    <div class="lg:col-span-2 space-y-8">
      
      <!-- How to Help -->
      <div>
        <h2 class="text-xl font-semibold text-gray-900 mb-4 border-l-4 border-gray-400 pl-4">
          How You Can Help
        </h2>
        <div class="space-y-3 text-gray-600">
          <p>Ward <%= @ward.ward_code %> needs volunteers to help with mapping and administrative tasks.</p>
          <ul class="space-y-2 ml-4">
            <li>• <%= @open_tickets.count %> tasks need volunteers</li>
            <li>• <%= @open_tickets.where(assigned_to: nil).count %> tasks are unassigned</li>
            <li>• <%= @prabhags.count - @prabhags.select { |p| p.boundary_geojson.present? }.count %> areas need boundary mapping</li>
          </ul>
          <% unless user_signed_in? %>
            <p class="mt-4">
              <%= link_to "Sign up", new_user_registration_path, class: "text-blue-600 hover:underline font-medium" %> 
              or 
              <%= link_to "sign in", new_user_session_path, class: "text-blue-600 hover:underline font-medium" %> 
              to help with tasks.
            </p>
          <% end %>
        </div>
      </div>

      <!-- Active Tasks -->
      <div>
        <h2 class="text-xl font-semibold text-gray-900 mb-4 border-l-4 border-gray-400 pl-4">
          Active Tasks & Issues
          <span class="text-base font-normal text-gray-500">(<%= @open_tickets.count %>)</span>
        </h2>
        
        <% if @open_tickets.any? %>
          <div class="space-y-4">
            <% @open_tickets.limit(8).each do |ticket| %>
              <div class="border-l border-gray-200 pl-4 py-3 hover:border-gray-400 hover:bg-gray-50 transition-colors">
                <div class="flex justify-between items-start mb-2">
                  <h3 class="font-medium text-gray-900"><%= ticket.title %></h3>
                  <span class="text-xs px-2 py-1 border rounded <%= 
                    case ticket.priority
                    when 'urgent' then 'border-red-300 text-red-700'
                    when 'high' then 'border-orange-300 text-orange-700'
                    when 'medium' then 'border-yellow-300 text-yellow-700'
                    else 'border-gray-300 text-gray-600'
                    end %>">
                    <%= ticket.priority %>
                  </span>
                </div>
                
                <p class="text-gray-600 text-sm mb-3"><%= truncate(ticket.description, length: 120) %></p>
                
                <div class="flex justify-between items-center text-xs text-gray-500">
                  <div class="space-x-4">
                    <span><%= ticket.ticket_type.humanize %></span>
                    <% if ticket.prabhag_number %>
                      <span>Prabhag <%= ticket.prabhag_number %></span>
                    <% end %>
                    <% if ticket.estimated_hours %>
                      <span>~<%= ticket.estimated_hours %>h</span>
                    <% end %>
                    <% if ticket.due_date %>
                      <span class="<%= ticket.overdue? ? 'text-red-600' : '' %>">
                        Due <%= ticket.due_date.strftime('%b %d') %>
                      </span>
                    <% end %>
                  </div>
                  
                  <div>
                    <% if ticket.assigned_to %>
                      <span class="text-green-600">Assigned to <%= ticket.assigned_to.name || ticket.assigned_to.email %></span>
                    <% elsif user_signed_in? %>
                      <%= link_to "Assign to me", assign_ticket_path(ticket), method: :post,
                                  class: "text-blue-600 hover:underline",
                                  data: { confirm: "Assign this task to yourself?" } %>
                    <% else %>
                      <span>Available</span>
                    <% end %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
          
          <% if @open_tickets.count > 8 %>
            <div class="mt-6 text-center">
              <%= link_to "View all #{@open_tickets.count} tasks →", ward_tickets_path(@ward.ward_code), 
                          class: "text-blue-600 hover:underline" %>
            </div>
          <% end %>
        <% else %>
          <p class="text-gray-500 italic">No active tasks. All issues have been assigned or completed.</p>
        <% end %>
      </div>

    </div>

    <!-- Sidebar -->
    <div class="space-y-8">
      
      <!-- BMC Contact -->
      <div>
        <h3 class="text-lg font-semibold text-gray-900 mb-4">BMC Officials</h3>
        <% if @ward.contact_officer_name.present? %>
          <div class="space-y-2 text-sm">
            <div><strong>Ward Officer:</strong> <%= @ward.contact_officer_name %></div>
            <% if @ward.contact_officer_email.present? %>
              <div><strong>Email:</strong> 
                <a href="mailto:<%= @ward.contact_officer_email %>" class="text-blue-600 hover:underline">
                  <%= @ward.contact_officer_email %>
                </a>
              </div>
            <% end %>
            <% if @ward.contact_officer_phone.present? %>
              <div><strong>Phone:</strong> 
                <a href="tel:<%= @ward.contact_officer_phone %>" class="text-blue-600 hover:underline">
                  <%= @ward.contact_officer_phone %>
                </a>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="text-gray-500 text-sm">Contact details will be updated soon</p>
        <% end %>
        
        <div class="mt-4 pt-4 border-t border-gray-200">
          <a href="https://portal.mcgm.gov.in" target="_blank" class="text-blue-600 hover:underline text-sm">
            Visit MCGM Portal →
          </a>
        </div>
      </div>

      <!-- Quick Actions -->
      <div>
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Quick Actions</h3>
        <div class="space-y-3">
          <%= link_to "View all tasks", ward_tickets_path(@ward.ward_code), 
                      class: "block text-blue-600 hover:underline" %>
          <%= link_to "Browse prabhags", ward_prabhags_path(@ward.ward_code), 
                      class: "block text-blue-600 hover:underline" %>
          <% if user_signed_in? %>
            <span class="block text-gray-400">Report issue (coming soon)</span>
          <% end %>
        </div>
      </div>

      <!-- Prabhags -->
      <div>
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
          Prabhags (<%= @prabhags.count %>)
        </h3>
        <div class="space-y-3">
          <% @prabhags.each do |prabhag| %>
            <% boundary = prabhag.approved_boundary %>
            <div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-b-0">
              <div>
                <span class="font-medium">Prabhag <%= prabhag.number %></span>
                <div class="text-xs ml-2">
                  <% if boundary %>
                    <% case boundary.source_type %>
                    <% when 'official_import' %>
                      <% if boundary.status == 'canonical' %>
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                          <div class="w-2 h-2 bg-green-400 rounded-full mr-1"></div>
                          Official (canonical)
                        </span>
                      <% else %>
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800">
                          <div class="w-2 h-2 bg-emerald-400 rounded-full mr-1"></div>
                          Official (approved)
                        </span>
                      <% end %>
                    <% when 'kml_import' %>
                      <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                        <div class="w-2 h-2 bg-orange-400 rounded-full mr-1"></div>
                        Legacy - needs mapping
                      </span>
                    <% when 'user_submission' %>
                      <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                        <div class="w-2 h-2 bg-purple-400 rounded-full mr-1"></div>
                        Community mapped
                      </span>
                    <% else %>
                      <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                        <div class="w-2 h-2 bg-gray-400 rounded-full mr-1"></div>
                        <%= boundary.source_type.humanize %>
                      </span>
                    <% end %>
                  <% else %>
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                      <div class="w-2 h-2 bg-red-400 rounded-full mr-1"></div>
                      Needs mapping
                    </span>
                  <% end %>
                </div>
              </div>
              <%= link_to "View", prabhag_path(prabhag),
                          class: "text-blue-600 hover:underline text-sm" %>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Statistics -->
      <div>
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Statistics</h3>
        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-gray-600">Total prabhags:</span>
            <span class="font-medium"><%= @prabhags.count %></span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Mapped:</span>
            <span class="font-medium"><%= @prabhags.select { |p| p.boundary_geojson.present? }.count %></span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Progress:</span>
            <span class="font-medium"><%= @ward.completion_percentage.to_i %>%</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Total tasks:</span>
            <span class="font-medium"><%= @tickets.count %></span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Active:</span>
            <span class="font-medium"><%= @open_tickets.count %></span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Completed:</span>
            <span class="font-medium"><%= @completed_tickets.count %></span>
          </div>
          <% if @ward.population_estimate.present? %>
            <div class="flex justify-between">
              <span class="text-gray-600">Population:</span>
              <span class="font-medium"><%= number_with_delimiter(@ward.population_estimate) %></span>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Completed Work -->
  <% if @completed_tickets.any? %>
    <div class="border-t border-gray-200 pt-8">
      <h2 class="text-xl font-semibold text-gray-900 mb-6">Recently Completed</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <% @completed_tickets.limit(6).each do |ticket| %>
          <div class="border-l border-green-200 pl-4">
            <h3 class="font-medium text-gray-900 mb-1"><%= ticket.title %></h3>
            <div class="text-sm text-gray-600 space-y-1">
              <div>By: <%= ticket.assigned_to&.name || ticket.assigned_to&.email || 'Volunteer' %></div>
              <div>Finished: <%= time_ago_in_words(ticket.updated_at) %> ago</div>
              <% if ticket.prabhag_number %>
                <div>Prabhag: <%= ticket.prabhag_number %></div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
</div>