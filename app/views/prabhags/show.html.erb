<div class="w-full">
  <!-- Breadcrumb Navigation -->
  <nav class="flex items-center space-x-2 text-sm mb-3">
    <%= link_to "Home", root_path, class: "text-blue-600 hover:text-blue-800" %>
    <span class="text-gray-400">/</span>
    <%= link_to "Wards", wards_path, class: "text-blue-600 hover:text-blue-800" %>
    <% if @ward %>
      <span class="text-gray-400">/</span>
      <%= link_to @ward.name, ward_path(@ward), class: "text-blue-600 hover:text-blue-800" %>
      <span class="text-gray-400">/</span>
      <span class="text-gray-700">Prabhag <%= @prabhag.number %></span>
    <% else %>
      <span class="text-gray-400">/</span>
      <%= link_to "Prabhags", prabhags_path, class: "text-blue-600 hover:text-blue-800" %>
      <span class="text-gray-400">/</span>
      <span class="text-gray-700">Prabhag <%= @prabhag.number %></span>
    <% end %>
  </nav>

  <!-- Compact Information-Dense Header with Map -->
  <div class="p-4 mb-8">
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
      <!-- Left Side: Dense Prabhag Information (3/4 width) -->
      <div class="lg:col-span-3">
        <!-- Title Row -->
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center space-x-4">
            <h1 class="text-2xl font-bold text-gray-900">Prabhag <%= @prabhag.number %></h1>
            <% case @prabhag.status %>
            <% when 'available' %>
              <span class="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-700">Unmapped</span>
            <% when 'assigned' %>
              <span class="px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-700">Mapping in Progress</span>
            <% when 'submitted' %>
              <span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-700">Under Review</span>
            <% when 'approved' %>
              <span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-700">Active Community</span>
            <% end %>
          </div>

          <!-- Quick Actions -->
          <div class="flex space-x-2">
            <% if user_signed_in? %>
              <% if @prabhag.can_be_assigned_to?(current_user) %>
                <%= link_to "Map This Area", assign_prabhag_path(@prabhag),
                              class: "px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium transition-colors",
                              data: { turbo_method: :post, confirm: "Assign this prabhag to yourself?" } %>
              <% elsif @prabhag.assigned_to == current_user && @prabhag.status == 'assigned' %>
                <%= link_to "Continue Mapping", trace_prabhag_path(@prabhag),
                              class: "px-3 py-1 bg-green-600 hover:bg-green-700 text-white text-sm font-medium transition-colors" %>
              <% end %>
            <% end %>
          </div>
        </div>

        <!-- Dense Information Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
          <!-- Column 1: Geographic Info -->
          <div class="space-y-1">
            <h3 class="font-semibold text-gray-900 text-xs uppercase tracking-wide">Location</h3>
            <% if @ward %>
              <div class="text-gray-700"><strong>Ward:</strong> <%= link_to @ward.name, ward_path(@ward), class: "text-blue-600 hover:text-blue-800" %></div>
              <div class="text-gray-600">Code: <%= @ward.ward_code %></div>
              <div class="text-gray-600">Population: <%= number_with_delimiter(@ward.population_estimate || 0) %></div>
              <div class="text-gray-600">Area: <%= @ward.total_area&.round(2) || '~0.3' %> km²</div>
            <% else %>
              <div class="text-gray-700"><strong>Ward Code:</strong> <%= @prabhag.ward_code %></div>
              <div class="text-gray-600">Population: ~2,400</div>
              <div class="text-gray-600">Area: ~0.3 km²</div>
            <% end %>
          </div>

          <!-- Column 2: Representatives & Contacts -->
          <div class="space-y-1">
            <h3 class="font-semibold text-gray-900 text-xs uppercase tracking-wide">Representatives</h3>
            <% if @ward&.contact_officer_name %>
              <div class="text-gray-700"><strong>Ward Officer:</strong> <%= @ward.contact_officer_name %></div>
            <% end %>
            <% if @ward&.contact_officer_phone %>
              <div class="text-gray-600">Phone: <%= @ward.contact_officer_phone %></div>
            <% end %>
            <% if @ward&.contact_officer_email %>
              <div class="text-gray-600">Email: <%= @ward.contact_officer_email %></div>
            <% end %>
            <% if @prabhag.assigned_to %>
              <div class="text-gray-600">Mapper: <%= @prabhag.assigned_to.name || @prabhag.assigned_to.email.split('@').first %></div>
            <% end %>
          </div>

          <!-- Column 3: Official Links & Status -->
          <div class="space-y-1">
            <h3 class="font-semibold text-gray-900 text-xs uppercase tracking-wide">Official Info</h3>
            <% if @ward %>
              <%= link_to "MCGM Ward Page", "https://portal.mcgm.gov.in/ward/#{@ward.ward_code}", target: '_blank',
                          class: "text-blue-600 hover:text-blue-800 block" %>
            <% end %>
            <% if @prabhag.status == 'approved' %>
              <div class="text-green-600"><i class="fas fa-check-circle mr-1"></i>Community Active</div>
              <div class="text-gray-600">Issues: <%= @community_stats&.dig(:active_issues) || 0 %> open</div>
              <div class="text-gray-600">Members: <%= @community_stats&.dig(:active_neighbors) || 0 %></div>
            <% else %>
              <div class="text-gray-600">Status: Boundary needed</div>
              <div class="text-gray-600">Community: Not active</div>
            <% end %>
            <%= link_to "Election Results", "#", class: "text-blue-600 hover:text-blue-800 text-xs" %>
            <%= link_to "Demographics", "#", class: "text-blue-600 hover:text-blue-800 text-xs" %>
          </div>
        </div>
      </div>

      <!-- Right Side: Map inside Header (1/4 width) -->
      <div class="lg:col-span-1">
        <% if @prabhag.boundary&.geojson.present? %>
          <div class="mb-2 text-xs text-gray-600">
            <%= @prabhag.boundary.status.humanize %> boundary
            <% if @prabhag.boundary.submitted_by %>
              by <%= @prabhag.boundary.submitted_by.name || @prabhag.boundary.submitted_by.email.split('@').first %>
            <% end %>
          </div>
          <div class="w-full h-64 bg-white rounded border border-gray-200 overflow-hidden"
               data-controller="ward-boundary"
               data-ward-boundary-data-url-value="<%= prabhag_path(@prabhag, format: :json) %>"
               data-ward-boundary-show-labels-value="true"
               data-ward-boundary-show-legend-value="false"
               data-ward-boundary-clickable-value="false"
               data-ward-boundary-zoom-value="16"
               data-ward-boundary-static-value="true">
            <div data-ward-boundary-target="container" class="w-full h-full desaturated-map"></div>
          </div>
        <% else %>
          <div class="w-full h-64 bg-gray-50 flex items-center justify-center">
            <div class="text-center text-gray-500">
              <i class="fas fa-map text-2xl mb-1 text-gray-400"></i>
              <p class="text-xs font-medium">No map yet</p>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Community Features for Active Prabhags -->
  <% if @prabhag.status == 'approved' %>
    <!-- Quick Actions -->
    <div class="mb-10">
      <h2 class="text-xl font-medium text-gray-900 mb-6 pb-3 border-b border-gray-200">Community Actions</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <button class="flex flex-col items-center p-4 hover:bg-blue-50 transition-colors text-center group">
          <i class="fas fa-exclamation-triangle text-2xl mb-2 text-red-500 group-hover:scale-110 transition-transform"></i>
          <span class="text-sm font-medium text-gray-900">Report Issue</span>
        </button>
        <button class="flex flex-col items-center p-4 hover:bg-gray-50 transition-colors text-center opacity-60 cursor-not-allowed">
          <i class="fas fa-comments text-2xl mb-2 text-gray-400"></i>
          <span class="text-sm font-medium text-gray-700">Discuss</span>
        </button>
        <button class="flex flex-col items-center p-4 hover:bg-gray-50 transition-colors text-center opacity-60 cursor-not-allowed">
          <i class="fas fa-calendar-days text-2xl mb-2 text-gray-400"></i>
          <span class="text-sm font-medium text-gray-700">Events</span>
        </button>
        <button class="flex flex-col items-center p-4 hover:bg-gray-50 transition-colors text-center opacity-60 cursor-not-allowed">
          <i class="fas fa-camera text-2xl mb-2 text-gray-400"></i>
          <span class="text-sm font-medium text-gray-700">Gallery</span>
        </button>
      </div>
    </div>

    <!-- Community Data Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 mb-12">
      <!-- Issues Section -->
      <div>
        <div class="flex justify-between items-center mb-6 pb-3 border-b border-gray-200">
          <h2 class="text-xl font-medium text-gray-900">Recent Issues</h2>
          <button class="bg-red-600 hover:bg-red-700 text-white font-medium px-4 py-2 transition-colors">Report New</button>
        </div>

        <div class="space-y-4">
          <% if @recent_tickets&.any? %>
            <% @recent_tickets.limit(3).each do |ticket| %>
              <div class="pb-4 border-b border-gray-100 last:border-b-0">
                <div class="flex justify-between items-start mb-2">
                  <h3 class="font-medium text-gray-900">
                    <span class="<%= ticket.status == 'open' ? 'text-red-500' : ticket.status == 'in_progress' ? 'text-yellow-500' : ticket.completed? ? 'text-green-500' : 'text-blue-500' %> mr-2">●</span>
                    <%= ticket.title %>
                  </h3>
                  <span class="text-xs <%= ticket.status == 'open' ? 'text-red-700' : ticket.status == 'in_progress' ? 'text-yellow-700' : ticket.completed? ? 'text-green-700' : 'text-blue-700' %> font-medium">
                    <%= ticket.status.humanize %>
                  </span>
                </div>
                <p class="text-gray-600 text-sm mb-2">
                  <%= truncate(ticket.description, length: 80) %>
                </p>
                <div class="text-xs text-gray-500">
                  <%= time_ago_in_words(ticket.created_at) %> ago by <%= ticket.created_by.name || ticket.created_by.email.split('@').first %>
                </div>
              </div>
            <% end %>
          <% else %>
            <div class="text-center py-8 text-gray-500">
              <i class="fas fa-building text-3xl mb-3 text-gray-400"></i>
              <p class="font-medium">No issues reported yet</p>
              <p class="text-sm text-gray-400 mt-1">Be the first to report a hyperlocal issue</p>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Community Stats & Activity -->
      <div class="space-y-8">
        <!-- Stats -->
        <div>
          <h3 class="text-xl font-medium text-gray-900 mb-6 pb-3 border-b border-gray-200">Community Stats</h3>
          <div class="space-y-4">
            <div class="flex justify-between items-center">
              <span class="text-gray-700">Active Issues</span>
              <span class="text-lg font-medium text-gray-900"><%= @community_stats[:active_issues] || 0 %></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-700">Active Neighbors</span>
              <span class="text-lg font-medium text-gray-900"><%= @community_stats[:active_neighbors] || 0 %></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-700">Resolution Rate</span>
              <span class="text-lg font-medium text-green-600"><%= @community_stats[:resolution_rate] || 0 %>%</span>
            </div>
          </div>
        </div>

        <!-- Recent Activity -->
        <div>
          <h3 class="text-xl font-medium text-gray-900 mb-6 pb-3 border-b border-gray-200">Recent Activity</h3>
          <div class="space-y-3">
            <% if @recent_activity&.any? %>
              <% @recent_activity&.first(3)&.each do |activity| %>
                <div class="flex items-start space-x-3">
                  <span class="<%= activity[:type] == 'issue' ? 'text-red-500' : 'text-blue-500' %> text-lg mt-0.5"><%= activity[:icon].html_safe %></span>
                  <div class="flex-1">
                    <span class="text-gray-900 text-sm"><%= activity[:text] %></span>
                    <p class="text-gray-500 text-xs mt-0.5"><%= activity[:time] %></p>
                  </div>
                </div>
              <% end %>
            <% else %>
              <div class="text-center py-6 text-gray-500">
                <i class="fas fa-mobile-alt text-2xl mb-2 text-gray-400"></i>
                <p class="text-sm">No recent activity</p>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-16">
    <!-- Prabhag Information -->
    <div>
      <h2 class="text-xl font-medium mb-6 pb-3 border-b border-gray-200">Prabhag Information</h2>
      <dl class="space-y-4">
        <div class="flex justify-between py-2">
          <dt class="text-gray-600">Number:</dt>
          <dd class="text-gray-900 font-medium"><%= @prabhag.number %></dd>
        </div>
        <div class="flex justify-between py-2">
          <dt class="text-gray-600">Ward:</dt>
          <dd class="text-gray-900 font-medium"><%= @prabhag.ward_code %></dd>
        </div>
        <div class="flex justify-between py-2">
          <dt class="text-gray-600">Status:</dt>
          <dd>
            <% case @prabhag.status %>
            <% when 'available' %>
            <span class="px-3 py-1 text-sm font-medium text-gray-700">Available</span>
            <% when 'assigned' %>
            <span class="px-3 py-1 text-sm font-medium text-yellow-700">In Progress</span>
            <% when 'submitted' %>
            <span class="px-3 py-1 text-sm font-medium text-blue-700">Under Review</span>
            <% when 'approved' %>
            <span class="px-3 py-1 text-sm font-medium text-green-700">Completed</span>
            <% when 'rejected' %>
            <span class="px-3 py-1 text-sm font-medium text-red-700">Rejected</span>
          <% end %>
        </dd>
      </div>
      <% if @prabhag.assigned_to %>
        <div class="flex justify-between py-2">
          <dt class="text-gray-600">Assigned to:</dt>
          <dd class="text-gray-900 font-medium"><%= @prabhag.assigned_to.name || @prabhag.assigned_to.email %></dd>
        </div>
      <% end %>
    </dl>
    </div>
    <!-- Actions -->
    <div>
      <h2 class="text-xl font-medium mb-6 pb-3 border-b border-gray-200">Actions</h2>
      <div class="space-y-4">
        <% if user_signed_in? %>
          <% if @prabhag.can_be_assigned_to?(current_user) %>
            <%= link_to "Assign to Me", assign_prabhag_path(@prabhag),
                          class: "block w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-6 text-center",
                          data: {
                            turbo_method: :post,
                            confirm: "Assign this prabhag to yourself?"
                          } %>
          <% elsif @prabhag.assigned_to == current_user %>
            <% if @prabhag.status == 'assigned' %>
              <%= link_to "Start Tracing", trace_prabhag_path(@prabhag),
                            class: "block w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-6 text-center" %>
            <% elsif @prabhag.status == 'submitted' %>
              <% if user_signed_in? && current_user.admin? %>
                <div class="space-y-4">
                  <div class="block w-full bg-orange-50 text-orange-800 font-medium py-3 px-6 text-center">
                    Submitted for Review
                  </div>
                  <div class="grid grid-cols-2 gap-4">
                    <%= button_to "✅ Approve", approve_admin_prabhag_path(@prabhag),
                                 class: "bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4",
                                 data: { confirm: "Approve this boundary? This will mark it as completed." } %>
                    <%= button_to "❌ Reject", reject_admin_prabhag_path(@prabhag),
                                 class: "bg-red-600 hover:bg-red-700 text-white font-medium py-3 px-4",
                                 data: { confirm: "Reject this boundary? This will make it available for reassignment." } %>
                  </div>
                </div>
              <% else %>
                <div class="block w-full bg-orange-50 text-orange-800 font-medium py-3 px-6 text-center">
                  Submitted for Review
                </div>
              <% end %>
            <% end %>
          <% else %>
            <div class="block w-full bg-gray-50 text-gray-700 font-medium py-3 px-6 text-center">
              <%= @prabhag.status == 'available' ? 'Available for Assignment' : 'Not Available' %>
            </div>
          <% end %>
        <% else %>
          <div class="text-center text-gray-600 py-4">
            <%= link_to "Sign in", new_user_session_path, class: "text-blue-600 hover:text-blue-800 font-medium" %> to assign this prabhag
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Boundary Review Section -->
  <% if @prabhag.boundaries.any? %>
    <div class="mt-12">
      <h2 class="text-xl font-medium mb-6 pb-3 border-b border-gray-200">Boundary History</h2>
      <div class="space-y-6">
        <% @prabhag.boundaries.order(:created_at).reverse_each do |boundary| %>
          <div class="pb-6 border-b border-gray-200 last:border-b-0">
            <div class="flex justify-between items-start mb-4">
              <div>
                <div class="flex items-center space-x-3 mb-2">
                  <% case boundary.status %>
                  <% when 'approved' %>
                    <span class="text-sm font-medium text-green-700">✅ Approved</span>
                  <% when 'rejected' %>
                    <span class="text-sm font-medium text-red-700">❌ Rejected</span>
                  <% when 'canonical' %>
                    <span class="text-sm font-medium text-purple-700">⭐ Canonical</span>
                  <% when 'pending' %>
                    <span class="text-sm font-medium text-yellow-700">⏳ Pending Review</span>
                  <% end %>
                  <span class="text-sm text-gray-600"><%= boundary.source_type.humanize %> • <%= boundary.year %></span>
                </div>
                <div class="text-gray-600 mb-2">
                  Submitted <%= time_ago_in_words(boundary.created_at) %> ago
                  <% if boundary.submitted_by %>
                    by <%= boundary.submitted_by.name || boundary.submitted_by.email %>
                  <% end %>
                </div>
                <% if boundary.approved_by && boundary.approved_at %>
                  <div class="text-gray-600">
                    Approved by <%= boundary.approved_by.name || boundary.approved_by.email %>
                    <%= time_ago_in_words(boundary.approved_at) %> ago
                  </div>
                <% end %>
                <% if boundary.rejection_reason.present? %>
                  <div class="text-red-600 mt-2">
                    <strong>Reason:</strong> <%= boundary.rejection_reason %>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

</div>
