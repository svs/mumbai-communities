<div class="w-full">
  <div class="flex justify-between items-center mb-8">
    <h1 class="font-bold text-3xl">Prabhag <%= @prabhag.number %></h1>
    <%= link_to "‚Üê Back to Prabhags", prabhags_path, class: "text-blue-500 hover:text-blue-700" %>
  </div>
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <!-- Prabhag Information -->
    <div class="space-y-6">
      <div class="bg-white border rounded-lg p-6 shadow-sm">
        <h2 class="text-xl font-semibold mb-4">Prabhag Information</h2>
        <dl class="space-y-2">
          <div class="flex justify-between">
            <dt class="font-medium text-gray-600">Number:</dt>
            <dd class="text-gray-900"><%= @prabhag.number %></dd>
          </div>
          <div class="flex justify-between">
            <dt class="font-medium text-gray-600">Ward:</dt>
            <dd class="text-gray-900"><%= @prabhag.ward_code %></dd>
          </div>
          <div class="flex justify-between">
            <dt class="font-medium text-gray-600">Status:</dt>
            <dd>
              <% case @prabhag.status %>
              <% when 'available' %>
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">Available</span>
              <% when 'assigned' %>
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">In Progress</span>
              <% when 'submitted' %>
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">Under Review</span>
              <% when 'approved' %>
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Completed</span>
              <% when 'rejected' %>
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">Rejected</span>
            <% end %>
          </dd>
        </div>
        <% if @prabhag.assigned_to %>
          <div class="flex justify-between">
            <dt class="font-medium text-gray-600">Assigned to:</dt>
            <dd class="text-gray-900"><%= @prabhag.assigned_to.name || @prabhag.assigned_to.email %></dd>
          </div>
        <% end %>
      </dl>
    </div>
    <!-- Actions -->
    <div class="bg-white border rounded-lg p-6 shadow-sm">
      <h2 class="text-xl font-semibold mb-4">Actions</h2>
      <div class="space-y-3">
        <%= link_to "View PDF", @prabhag.pdf_url, target: '_blank',
                      class: "block w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded text-center" %>
        <% if user_signed_in? %>
          <% if @prabhag.can_be_assigned_to?(current_user) %>
            <%= link_to "Assign to Me", assign_prabhag_path(@prabhag),
                          class: "block w-full bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded text-center",
                          data: { 
                            turbo_method: :post,
                            confirm: "Assign this prabhag to yourself?" 
                          } %>
          <% elsif @prabhag.assigned_to == current_user %>
            <% if @prabhag.status == 'assigned' %>
              <%= link_to "Start Tracing", trace_prabhag_path(@prabhag),
                            class: "block w-full bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded text-center" %>
            <% elsif @prabhag.status == 'submitted' %>
              <% if user_signed_in? && current_user.admin? %>
                <div class="space-y-3">
                  <div class="block w-full bg-orange-100 text-orange-800 font-bold py-2 px-4 rounded text-center">
                    Submitted for Review
                  </div>
                  <div class="grid grid-cols-2 gap-3">
                    <%= button_to "‚úÖ Approve", approve_admin_prabhag_path(@prabhag),
                                 class: "bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded",
                                 data: { confirm: "Approve this boundary? This will mark it as completed." } %>
                    <%= button_to "‚ùå Reject", reject_admin_prabhag_path(@prabhag),
                                 class: "bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded",
                                 data: { confirm: "Reject this boundary? This will make it available for reassignment." } %>
                  </div>
                </div>
              <% else %>
                <div class="block w-full bg-orange-100 text-orange-800 font-bold py-2 px-4 rounded text-center">
                  Submitted for Review
                </div>
              <% end %>
            <% end %>
          <% else %>
            <div class="block w-full bg-gray-100 text-gray-600 font-bold py-2 px-4 rounded text-center">
              <%= @prabhag.status == 'available' ? 'Available for Assignment' : 'Not Available' %>
            </div>
          <% end %>
        <% else %>
          <div class="text-center text-gray-600">
            <%= link_to "Sign in", new_user_session_path, class: "text-blue-600 hover:text-blue-800" %> to assign this prabhag
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Boundary Review Section -->
  <% if @prabhag.boundaries.any? %>
    <div class="bg-white border rounded-lg p-6 shadow-sm">
      <h2 class="text-xl font-semibold mb-4">Boundary History</h2>
      <div class="space-y-4">
        <% @prabhag.boundaries.order(:created_at).reverse_each do |boundary| %>
          <div class="border rounded-lg p-4 <%= boundary.status == 'approved' ? 'border-green-200 bg-green-50' : boundary.status == 'rejected' ? 'border-red-200 bg-red-50' : boundary.status == 'canonical' ? 'border-purple-200 bg-purple-50' : 'border-yellow-200 bg-yellow-50' %>">
            <div class="flex justify-between items-start mb-3">
              <div>
                <div class="flex items-center space-x-2">
                  <% case boundary.status %>
                  <% when 'approved' %>
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">‚úÖ Approved</span>
                  <% when 'rejected' %>
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">‚ùå Rejected</span>
                  <% when 'canonical' %>
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-800">‚≠ê Canonical</span>
                  <% when 'pending' %>
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">‚è≥ Pending Review</span>
                  <% end %>
                  <span class="text-sm text-gray-600"><%= boundary.source_type.humanize %> ‚Ä¢ <%= boundary.year %></span>
                </div>
                <div class="text-sm text-gray-600 mt-1">
                  Submitted <%= time_ago_in_words(boundary.created_at) %> ago
                  <% if boundary.submitted_by %>
                    by <%= boundary.submitted_by.name || boundary.submitted_by.email %>
                  <% end %>
                </div>
                <% if boundary.approved_by && boundary.approved_at %>
                  <div class="text-sm text-gray-600">
                    Approved by <%= boundary.approved_by.name || boundary.approved_by.email %>
                    <%= time_ago_in_words(boundary.approved_at) %> ago
                  </div>
                <% end %>
                <% if boundary.rejection_reason.present? %>
                  <div class="text-sm text-red-600 mt-1">
                    <strong>Reason:</strong> <%= boundary.rejection_reason %>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Map Preview -->
  <div class="bg-white border rounded-lg p-6 shadow-sm">
    <h2 class="text-xl font-semibold mb-4">Map Preview</h2>
    <% boundary_to_show = @prabhag.boundary %>
    <% if boundary_to_show&.geojson.present? %>
      <div class="mb-3 text-sm text-gray-600">
        Showing <%= boundary_to_show.status %> boundary
        (<%= boundary_to_show.source_type.humanize %>, <%= boundary_to_show.year %>)
        <% if boundary_to_show.submitted_by %>
          submitted by <%= boundary_to_show.submitted_by.name || boundary_to_show.submitted_by.email %>
        <% end %>
      </div>
      <div id="map" class="border rounded h-96"></div>
      <script>
        function initMap() {
          const geojson = <%= boundary_to_show.geojson.html_safe %>;
          const coordinates = geojson.geometry.coordinates[0];
          const path = coordinates.map(coord => ({ lat: coord[1], lng: coord[0] }));

          // Calculate center
          const bounds = new google.maps.LatLngBounds();
          path.forEach(point => bounds.extend(point));
          const center = bounds.getCenter();

          const map = new google.maps.Map(document.getElementById('map'), {
            center: center,
            zoom: 15,
            mapTypeId: 'roadmap'
          });

          // Fit bounds to polygon
          map.fitBounds(bounds, 50);

          // Create the polygon
          const polygon = new google.maps.Polygon({
            paths: path,
            strokeColor: '<%= boundary_to_show.status == 'canonical' ? '#8B5CF6' : boundary_to_show.status == 'approved' ? '#10B981' : boundary_to_show.status == 'rejected' ? '#EF4444' : '#F59E0B' %>',
            strokeOpacity: 0.8,
            strokeWeight: 3,
            fillColor: '<%= boundary_to_show.status == 'canonical' ? '#8B5CF6' : boundary_to_show.status == 'approved' ? '#10B981' : boundary_to_show.status == 'rejected' ? '#EF4444' : '#F59E0B' %>',
            fillOpacity: 0.2,
            editable: false,
            clickable: false
          });

          polygon.setMap(map);
        }
      </script>
      <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCdaO8AJfaBvqAWeAwHSp4c282lVOEgHgk&callback=initMap" async defer></script>
    <% else %>
      <div class="border rounded bg-gray-50">
        <div class="h-96 flex items-center justify-center">
          <div class="text-center">
            <img src="<%= @prabhag.map_image_src %>"
                 alt="Prabhag <%= @prabhag.number %> PDF Map"
                 class="max-w-full max-h-full object-contain rounded shadow-sm"
                 onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
            <div class="text-gray-600" style="display: none;">
              <p>No boundary data available</p>
              <p class="text-sm">PDF map image not found</p>
              <p class="text-sm mt-2">
                <%= link_to "View original PDF", @prabhag.pdf_url, target: '_blank', class: "text-blue-600 hover:underline" %>
              </p>
            </div>
          </div>
        </div>

        <!-- Instructions and CTA for tracing -->
        <div class="border-t bg-amber-50 p-4">
          <div class="flex items-start space-x-3">
            <div class="flex-shrink-0">
              <svg class="w-5 h-5 text-amber-600 mt-1" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
              </svg>
            </div>
            <div class="flex-1">
              <h3 class="text-sm font-medium text-amber-800 mb-2">
                Boundary needs to be traced
              </h3>
              <div class="text-sm text-amber-700 space-y-2">
                <p>This prabhag boundary hasn't been digitally traced yet. You can help by:</p>
                <ul class="list-disc list-inside space-y-1 ml-2">
                  <li>Using the boundary tracing tool to outline the area shown in the image above</li>
                  <li>Following the boundary lines carefully from the official MCGM PDF</li>
                  <li>Submitting your traced boundary for review and approval</li>
                </ul>
              </div>
              <div class="mt-4 flex flex-col sm:flex-row gap-3">
                <% if user_signed_in? %>
                  <% if @prabhag.can_be_assigned_to?(current_user) %>
                    <%= link_to "üéØ Start Tracing This Boundary", trace_prabhag_path(@prabhag),
                                class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-amber-600 hover:bg-amber-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 transition-colors" %>
                  <% elsif @prabhag.assigned_to == current_user %>
                    <%= link_to "Continue Tracing", trace_prabhag_path(@prabhag),
                                class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-amber-600 hover:bg-amber-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 transition-colors" %>
                  <% else %>
                    <span class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-500 bg-gray-100 cursor-not-allowed">
                      Already assigned
                    </span>
                  <% end %>
                <% else %>
                  <%= link_to "Sign In to Help Trace", new_user_session_path,
                              class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors" %>
                <% end %>
                <%= link_to "View Original PDF", @prabhag.pdf_url, target: '_blank',
                            class: "inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 transition-colors" %>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>
</div>
